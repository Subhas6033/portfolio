import { SMTPClient } from "emailjs";
import { asyncHandeler, ApiError, ApiResponse } from "../Utils/index.js";
import { Contact } from "../Models/Contact.models.js";

console.log("Email details => ", process.env.EMAIL_HOST, process.env.EMAIL_PASSWORD,process.env.EMAIL_USER, "Subhas")
const client = new SMTPClient({
  user: process.env.EMAIL_USER,
  password: process.env.EMAIL_PASSWORD,
  host: process.env.EMAIL_HOST,
  ssl: true,
});


const handleContactForm = asyncHandeler(async (req, res) => {

  const { userName, email, mobileNumber, subject, message } = req.body;

  // Check that all fields are received or not 
  if ([userName, email, mobileNumber, subject, message].some((f) => !f || f.trim() === "")) {
    throw new ApiError(400, "All fields are required!");
  }

  //  User confirmation email
  const userMail = {
    from: `Subhas Mondal <${process.env.EMAIL_USER}>`,
    to: email,
    subject: `ðŸ’¬ Weâ€™ve received your message: ${subject}`,
    attachment: [
      {
        data: `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7fb; padding: 40px 20px;">
          <div style="max-width: 600px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
            <div style="background-color: #2563eb; color: white; padding: 25px 30px;">
              <h2 style="margin: 0; font-size: 22px;">Thank You for Contacting Me ðŸ’–</h2>
            </div>
            <div style="padding: 25px 30px; color: #333;">
              <p>Hi <strong>${userName}</strong>,</p>
              <p>Thank you for reaching out! Iâ€™ve received your message and will get back to you shortly.</p>
              <p style="margin-top: 15px;">Hereâ€™s a summary of your message:</p>
              <table style="width: 100%; border-collapse: collapse; margin-top: 10px; background-color: #f9fafb; border-radius: 8px;">
                <tr><td style="padding: 10px; font-weight: 600;">Name:</td><td style="padding: 10px;">${userName}</td></tr>
                <tr><td style="padding: 10px; font-weight: 600;">Email:</td><td style="padding: 10px;">${email}</td></tr>
                <tr><td style="padding: 10px; font-weight: 600;">Mobile:</td><td style="padding: 10px;">${mobileNumber}</td></tr>
                <tr><td style="padding: 10px; font-weight: 600;">Subject:</td><td style="padding: 10px;">${subject}</td></tr>
              </table>
              <p style="margin-top: 20px;"><strong>Your Message:</strong></p>
              <blockquote style="background: #eef3ff; padding: 15px 20px; border-left: 4px solid #2563eb; border-radius: 8px; color: #444;">
                ${message}
              </blockquote>
              <p style="margin-top: 25px;">Best regards,<br/><strong>Subhas Mondal</strong><br/><span style="font-size: 13px; color: #666;">Portfolio Website</span></p>
            </div>
            <div style="background: #f9fafb; padding: 15px 25px; font-size: 13px; color: #777; text-align: center;">
              This is an automated confirmation â€” please do not reply directly.
            </div>
          </div>
        </div>`,
        alternative: true,
      },
    ],
  };

  //  Notification email to the Admin of the project
  const ownerMail = {
    from: `${userName} <${email}>`,
    to: process.env.EMAIL_USER,
    subject: `ðŸ“© New Contact Form Submission: ${subject}`,
    attachment: [
      {
        data: `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7fb; padding: 40px 20px;">
          <div style="max-width: 600px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
            <div style="background-color: #2563eb; color: white; padding: 25px 30px;">
              <h2 style="margin: 0; font-size: 22px;">ðŸ“¨ New Contact Form Submission</h2>
            </div>
            <div style="padding: 25px 30px; color: #333;">
              <p><strong>Name:</strong> ${userName}</p>
              <p><strong>Email:</strong> ${email}</p>
              <p><strong>Mobile:</strong> ${mobileNumber}</p>
              <p><strong>Subject:</strong> ${subject}</p>
              <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;" />
              <p style="margin-top: 10px;"><strong>Message:</strong></p>
              <blockquote style="background: #f9fafb; padding: 15px 20px; border-left: 4px solid #2563eb; border-radius: 6px; color: #444;">
                ${message}
              </blockquote>
            </div>
            <div style="background: #f9fafb; padding: 15px 25px; font-size: 13px; color: #777; text-align: center;">
              This email was automatically generated by your website contact form.
            </div>
          </div>
        </div>`,
        alternative: true,
      },
    ],
  };

  //  Save contact details in DB
  const savedContact = await Contact.create({
    userName,
    email,
    mobileNumber,
    subject,
    message,
  });

  //  Send both emails
  try {
    await Promise.all([
      client.sendAsync(userMail),
      client.sendAsync(ownerMail),
    ]);

    res
      .status(200)
      .json(new ApiResponse(200, "Emails sent and contact saved successfully", savedContact));
  } catch (error) {
    console.error("Email Error:", error);
    throw new ApiError(500, "Failed to send emails");
  }
});

export { handleContactForm };
